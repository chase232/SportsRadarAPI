//>>built
define("dgrid/Tree",["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/aspect","dojo/on","dojo/query","dojo/when","./util/has-css3","./Grid","dojo/has!touch?./util/touch","put-selector/put"],function(_1,_2,_3,_4,on,_5,_6,_7,_8,_9,_a){return _1(null,{collapseOnRefresh:false,enableTreeTransitions:true,treeIndentWidth:9,constructor:function(){this._treeColumnListeners=[];},shouldExpand:function(_b,_c,_d){return _d;},expand:function(_e,_f,_10){if(!this._treeColumn){return;}var _11=this,row=_e.element?_e:this.row(_e),_12=!!this._expanded[row.id],_13=_7("transitionend"),_14;_e=row.element;_e=_e.className.indexOf("dgrid-expando-icon")>-1?_e:_5(".dgrid-expando-icon",_e)[0];_10=_10||!this.enableTreeTransitions;if(_e&&_e.mayHaveChildren&&(_10||_f!==_12)){var _15=_f===undefined?!this._expanded[row.id]:_f;_a(_e,".ui-icon-triangle-1-"+(_15?"se":"e")+"!ui-icon-triangle-1-"+(_15?"e":"se"));_a(row.element,(_15?".":"!")+"dgrid-row-expanded");var _16=row.element,_17=_16.connected,_18,_19,_1a={};if(!_17){_17=_1a.container=_16.connected=_a(_16,"+div.dgrid-tree-container");var _1b=function(_1c){var _1d=_11._renderedCollection.getChildren(row.data),_1e;if(_11.sort){_1d=_1d.sort(_11.sort);}if(_1d.track&&_11.shouldTrackCollection){_17._rows=_1c.rows=[];_1d=_1d.track();_17._handles=[_1d.tracking,_11._observeCollection(_1d,_17,_1c)];}if("start" in _1c){var _1f={start:_1c.start,end:_1c.start+_1c.count};_1e=_1d.fetchRange(_1f);}else{_1e=_1d.fetch();}return _1e;};if("level" in _e){_1b.level=_e.level;}if(this.renderQuery){_14=this.renderQuery(_1b,_1a);}else{var _20=_a(_17,"div");_14=this._trackError(function(){return _11.renderQueryResults(_1b(_1a),_20,_2.mixin({rows:_1a.rows},"level" in _1b?{queryLevel:_1b.level}:null)).then(function(_21){_a(_20,"!");return _21;});});}if(_13&&!_10){on.once(_17,_13,this._onTreeTransitionEnd);}else{this._onTreeTransitionEnd.call(_17);}}_17.hidden=!_15;_18=_17.style;if(!_13||_10){_18.display=_15?"block":"none";_18.height="";}else{if(_15){_18.display="block";_19=_17.scrollHeight;_18.height="0px";}else{_a(_17,".dgrid-tree-resetting");_18.height=_17.scrollHeight+"px";}setTimeout(function(){_a(_17,"!dgrid-tree-resetting");_18.height=_15?(_19?_19+"px":"auto"):"0px";},0);}if(_15){this._expanded[row.id]=true;}else{delete this._expanded[row.id];}}return _6(_14);},_configColumns:function(){var _22=this.inherited(arguments);this._expanded={};for(var i=0,l=_22.length;i<l;i++){if(_22[i].renderExpando){this._configureTreeColumn(_22[i]);break;}}return _22;},insertRow:function(){var _23=this.inherited(arguments);var row=this.row(_23),_24=this.shouldExpand(row,this._currentLevel,this._expanded[row.id]);if(_24){this.expand(_23,true,true);}return _23;},removeRow:function(_25,_26){var _27=_25.connected,_28={};if(_27){if(_27._handles){_3.forEach(_27._handles,function(_29){_29.remove();});delete _27._handles;}if(_27._rows){_28.rows=_27._rows;}_5(">.dgrid-row",_27).forEach(function(_2a){this.removeRow(_2a,true,_28);},this);if(_27._rows){_27._rows.length=0;delete _27._rows;}if(!_26){_a(_27,"!");}}this.inherited(arguments);},cleanup:function(){this.inherited(arguments);if(this.collapseOnRefresh){this._expanded={};}},_destroyColumns:function(){var _2b=this._treeColumnListeners;for(var i=_2b.length;i--;){_2b[i].remove();}this._treeColumnListeners=[];this._treeColumn=null;},_calcRowHeight:function(_2c){var _2d=_2c.connected;return this.inherited(arguments)+(_2d?_2d.offsetHeight:0);},_configureTreeColumn:function(_2e){var _2f=_2e.renderCell||this._defaultRenderCell;var _30;this._treeColumn=_2e;var _31=this,_32=".dgrid-content .dgrid-column-"+_2e.id;if(!_31.collection){throw new Error("dgrid Tree mixin requires a collection to operate.");}if(typeof _2e.renderExpando!=="function"){_2e.renderExpando=this._defaultRenderExpando;}this._treeColumnListeners.push(this.on(_2e.expandOn||".dgrid-expando-icon:click,"+_32+":dblclick,"+_32+":keydown",function(_33){var row=_31.row(_33);if((!_31.collection.mayHaveChildren||_31.collection.mayHaveChildren(row.data))&&(_33.type!=="keydown"||_33.keyCode===32)&&!(_33.type==="dblclick"&&_30&&_30.count>1&&row.id===_30.id&&_33.target.className.indexOf("dgrid-expando-icon")>-1)){_31.expand(row);}if(_33.target.className.indexOf("dgrid-expando-icon")>-1){if(_30&&_30.id===_31.row(_33).id){_30.count++;}else{_30={id:_31.row(_33).id,count:1};}}}));if(_7("touch")){this._treeColumnListeners.push(this.on(_9.selector(_32,_9.dbltap),function(){_31.expand(this);}));}_2e.renderCell=function(_34,_35,td,_36){var _37=_2e.grid,_38=Number(_36&&_36.queryLevel)+1,_39=!_37.collection.mayHaveChildren||_37.collection.mayHaveChildren(_34),_3a,_3b;_38=_37._currentLevel=isNaN(_38)?0:_38;_3a=_2e.renderExpando(_38,_39,_37._expanded[_37.collection.getIdentity(_34)],_34);_3a.level=_38;_3a.mayHaveChildren=_39;_3b=_2f.call(_2e,_34,_35,td,_36);if(_3b&&_3b.nodeType){_a(td,_3a);_a(td,_3b);}else{td.insertBefore(_3a,td.firstChild);}};},_defaultRenderExpando:function(_3c,_3d,_3e){var dir=this.grid.isRTL?"right":"left",cls=".dgrid-expando-icon",_3f;if(_3d){cls+=".ui-icon.ui-icon-triangle-1-"+(_3e?"se":"e");}_3f=_a("div"+cls+"[style=margin-"+dir+": "+(_3c*this.grid.treeIndentWidth)+"px; float: "+dir+"]");_3f.innerHTML="&nbsp;";return _3f;},_onTreeTransitionEnd:function(_40){var _41=this,_42=this.style.height;if(_42){this.style.display=_42==="0px"?"none":"block";}if(_40){_a(this,".dgrid-tree-resetting");setTimeout(function(){_a(_41,"!dgrid-tree-resetting");},0);}this.style.height="";}});});