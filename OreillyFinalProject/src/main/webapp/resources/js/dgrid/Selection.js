//>>built
define("dgrid/Selection",["dojo/_base/declare","dojo/on","dojo/has","dojo/aspect","./List","dojo/has!touch?./util/touch","put-selector/put","dojo/query","dojo/_base/sniff"],function(_1,on,_2,_3,_4,_5,_6){_2.add("dom-comparedocumentposition",function(_7,_8,_9){return !!_9.compareDocumentPosition;});_2.add("css-user-select",function(_a,_b,_c){var _d=_c.style,_e=["Khtml","O","ms","Moz","Webkit"],i=_e.length,_f="userSelect";do{if(typeof _d[_f]!=="undefined"){return _f;}}while(i--&&(_f=_e[i]+"UserSelect"));return false;});_2.add("dom-selectstart",typeof document.onselectstart!=="undefined");var _10=_2("mac")?"metaKey":"ctrlKey",_11=_2("css-user-select"),_12=_2("pointer"),_13=_12&&_12.slice(0,2)==="MS",_14=_12?_12+(_13?"Down":"down"):"mousedown",_15=_12?_12+(_13?"Up":"up"):"mouseup";function _16(_17,_18){var _19=_17.unselectable=_18?"on":"",_1a=_17.getElementsByTagName("*"),i=_1a.length;while(--i){if(_1a[i].tagName==="INPUT"||_1a[i].tagName==="TEXTAREA"){continue;}_1a[i].unselectable=_19;}};function _1b(_1c,_1d){var _1e=_1c.bodyNode,_1f=_1d?"text":_2("ff")<21?"-moz-none":"none";if(_11&&_11!=="msUserSelect"){_1e.style[_11]=_1f;}else{if(_2("dom-selectstart")){if(!_1d&&!_1c._selectstartHandle){_1c._selectstartHandle=on(_1e,"selectstart",function(evt){var tag=evt.target&&evt.target.tagName;if(tag!=="INPUT"&&tag!=="TEXTAREA"){evt.preventDefault();}});}else{if(_1d&&_1c._selectstartHandle){_1c._selectstartHandle.remove();delete _1c._selectstartHandle;}}}else{_16(_1e,!_1d);if(!_1d&&!_1c._unselectableHandle){_1c._unselectableHandle=_3.after(_1c,"renderRow",function(row){_16(row,true);return row;});}else{if(_1d&&_1c._unselectableHandle){_1c._unselectableHandle.remove();delete _1c._unselectableHandle;}}}}};return _1(null,{selectionDelegate:".dgrid-row",selectionEvents:_14+","+_15+",dgrid-cellfocusin",selectionTouchEvents:_2("touch")?_5.tap:null,deselectOnRefresh:true,allowSelectAll:false,selection:{},selectionMode:"extended",allowTextSelection:undefined,_selectionTargetType:"rows",create:function(){this.selection={};return this.inherited(arguments);},postCreate:function(){this.inherited(arguments);this._initSelectionEvents();var _20=this.selectionMode;this.selectionMode="";this._setSelectionMode(_20);},destroy:function(){this.inherited(arguments);if(this._selectstartHandle){this._selectstartHandle.remove();}if(this._unselectableHandle){this._unselectableHandle.remove();}if(this._removeDeselectSignals){this._removeDeselectSignals();}},_setSelectionMode:function(_21){if(_21===this.selectionMode){return;}this.clearSelection();this.selectionMode=_21;this._selectionHandlerName="_"+_21+"SelectionHandler";this._setAllowTextSelection(this.allowTextSelection);},_setAllowTextSelection:function(_22){if(typeof _22!=="undefined"){_1b(this,_22);}else{_1b(this,this.selectionMode==="none");}this.allowTextSelection=_22;},_handleSelect:function(_23,_24){if(!this[this._selectionHandlerName]||!this.allowSelect(this.row(_24))||(_23.type==="dgrid-cellfocusin"&&_23.parentType==="mousedown")||(_23.type===_15&&_24!==this._waitForMouseUp)){return;}this._waitForMouseUp=null;this._selectionTriggerEvent=_23;if(!_23.keyCode||!_23.ctrlKey||_23.keyCode===32){if(!_23.shiftKey&&_23.type===_14&&this.isSelected(_24)){this._waitForMouseUp=_24;}else{this[this._selectionHandlerName](_23,_24);}}this._selectionTriggerEvent=null;},_singleSelectionHandler:function(_25,_26){var _27=_25.keyCode?_25.ctrlKey:_25[_10];if(this._lastSelected===_26){this.select(_26,null,!_27||!this.isSelected(_26));}else{this.clearSelection();this.select(_26);this._lastSelected=_26;}},_multipleSelectionHandler:function(_28,_29){var _2a=this._lastSelected,_2b=_28.keyCode?_28.ctrlKey:_28[_10],_2c;if(!_28.shiftKey){_2c=_2b?null:true;_2a=null;}this.select(_29,_2a,_2c);if(!_2a){this._lastSelected=_29;}},_extendedSelectionHandler:function(_2d,_2e){if(_2d.button===2?!this.isSelected(_2e):!(_2d.keyCode?_2d.ctrlKey:_2d[_10])){this.clearSelection(null,true);}this._multipleSelectionHandler(_2d,_2e);},_toggleSelectionHandler:function(_2f,_30){this.select(_30,null,null);},_initSelectionEvents:function(){var _31=this,_32=this.contentNode,_33=this.selectionDelegate;this._selectionEventQueues={deselect:[],select:[]};if(_2("touch")&&!_2("pointer")&&this.selectionTouchEvents){on(_32,_5.selector(_33,this.selectionTouchEvents),function(evt){_31._handleSelect(evt,this);_31._ignoreMouseSelect=this;});on(_32,on.selector(_33,this.selectionEvents),function(_34){if(_31._ignoreMouseSelect!==this){_31._handleSelect(_34,this);}else{if(_34.type===_15){_31._ignoreMouseSelect=null;}}});}else{on(_32,on.selector(_33,this.selectionEvents),function(_35){_31._handleSelect(_35,this);});}if(this.addKeyHandler){this.addKeyHandler(32,function(_36){_31._handleSelect(_36,_36.target);});}if(this.allowSelectAll){this.on("keydown",function(_37){if(_37[_10]&&_37.keyCode===65&&!/\bdgrid-input\b/.test(_37.target.className)){_37.preventDefault();_31[_31.allSelected?"clearSelection":"selectAll"]();}});}if(this._setCollection){_3.before(this,"_setCollection",function(_38){_31._updateDeselectionAspect(_38);});}this._updateDeselectionAspect();},_updateDeselectionAspect:function(_39){var _3a=this,_3b;function _3c(_3d,_3e){var row=_3a.row(_3d),_3f=row&&_3a.selection[row.id];if(_3f){_3a[_3e](row);}};if(this._removeDeselectSignals){this._removeDeselectSignals();}if(_39&&_39.track&&this._observeCollection){_3b=[_3.before(this,"_observeCollection",function(_40){_3b.push(_40.on("delete",function(_41){if(typeof _41.index==="undefined"){_3c(_41.id,"deselect");}}));}),_3.after(this,"_observeCollection",function(_42){_3b.push(_42.on("update",function(_43){if(typeof _43.index!=="undefined"){_3c(_42.getIdentity(_43.target),"select");}}));},true)];}else{_3b=[_3.before(this,"removeRow",function(_44,_45){var row;if(!_45){row=this.row(_44);if(row&&(row.id in this.selection)){this.deselect(row);}}})];}this._removeDeselectSignals=function(){for(var i=_3b.length;i--;){_3b[i].remove();}_3b=[];};},allowSelect:function(){return true;},_fireSelectionEvent:function(_46){var _47=this._selectionEventQueues[_46],_48=this._selectionTriggerEvent,_49;_49={bubbles:true,grid:this};if(_48){_49.parentType=_48.type;}_49[this._selectionTargetType]=_47;this._selectionEventQueues[_46]=[];on.emit(this.contentNode,"dgrid-"+_46,_49);},_fireSelectionEvents:function(){var _4a=this._selectionEventQueues,_4b;for(_4b in _4a){if(_4a[_4b].length){this._fireSelectionEvent(_4b);}}},_select:function(row,_4c,_4d){var _4e,_4f,_50,_51,_52;if(typeof _4d==="undefined"){_4d=true;}if(!row.element){row=this.row(row);}if(_4d===false||this.allowSelect(row)){_4e=this.selection;_4f=!!_4e[row.id];if(_4d===null){_4d=!_4f;}_50=row.element;if(!_4d&&!this.allSelected){delete this.selection[row.id];}else{_4e[row.id]=_4d;}if(_50){if(_4d){_6(_50,".dgrid-selected"+(this.addUiClasses?".ui-state-active":""));}else{_6(_50,"!dgrid-selected!ui-state-active");}}if(_4d!==_4f&&_50){this._selectionEventQueues[(_4d?"":"de")+"select"].push(row);}if(_4c){if(!_4c.element){_4c=this.row(_4c);}if(!_4c){this._lastSelected=_50;console.warn("The selection range has been reset because the "+"beginning of the selection is no longer in the DOM. "+"If you are using OnDemandList, you may wish to increase "+"farOffRemoval to avoid this, but note that keeping more nodes "+"in the DOM may impact performance.");return;}_51=_4c.element;if(_51){_52=this._determineSelectionDirection(_50,_51);if(!_52){_51=document.getElementById(_51.id);_52=this._determineSelectionDirection(_50,_51);}while(row.element!==_51&&(row=this[_52](row))){this._select(row,null,_4d);}}}}},_determineSelectionDirection:_2("dom-comparedocumentposition")?function(_53,to){var _54=to.compareDocumentPosition(_53);if(_54&1){return false;}return _54===2?"down":"up";}:function(_55,to){if(to.sourceIndex<1){return false;}return to.sourceIndex>_55.sourceIndex?"down":"up";},select:function(row,_56,_57){this._select(row,_56,_57);this._fireSelectionEvents();},deselect:function(row,_58){this.select(row,_58,false);},clearSelection:function(_59,_5a){this.allSelected=false;for(var id in this.selection){if(_59!==id){this._select(id,null,false);}}if(!_5a){this._lastSelected=null;}this._fireSelectionEvents();},selectAll:function(){this.allSelected=true;this.selection={};for(var i in this._rowIdToObject){var row=this.row(this._rowIdToObject[i]);this._select(row.id,null,true);}this._fireSelectionEvents();},isSelected:function(_5b){if(typeof _5b==="undefined"||_5b===null){return false;}if(!_5b.element){_5b=this.row(_5b);}return (_5b.id in this.selection)?!!this.selection[_5b.id]:this.allSelected&&(!_5b.data||this.allowSelect(_5b));},refresh:function(){if(this.deselectOnRefresh){this.clearSelection();}this._lastSelected=null;return this.inherited(arguments);},renderArray:function(){var _5c=this.inherited(arguments),_5d=this.selection,i,row,_5e;for(i=0;i<_5c.length;i++){row=this.row(_5c[i]);_5e=row.id in _5d?_5d[row.id]:this.allSelected;if(_5e){this.select(row,null,_5e);}}this._fireSelectionEvents();return _5c;}});});