//>>built
define("dgrid/Keyboard",["dojo/_base/declare","dojo/aspect","dojo/on","dojo/_base/lang","dojo/has","put-selector/put","./util/misc","dojo/_base/sniff"],function(_1,_2,on,_3,_4,_5,_6){var _7={checkbox:1,radio:1,button:1},_8=/\bdgrid-cell\b/,_9=/\bdgrid-row\b/;var _a=_1(null,{pageSkip:10,tabIndex:0,keyMap:null,headerKeyMap:null,postMixInProperties:function(){this.inherited(arguments);if(!this.keyMap){this.keyMap=_3.mixin({},_a.defaultKeyMap);}if(!this.headerKeyMap){this.headerKeyMap=_3.mixin({},_a.defaultHeaderKeyMap);}},postCreate:function(){this.inherited(arguments);var _b=this;function _c(_d){var _e=_d.target;return _e.type&&(!_7[_e.type]||_d.keyCode===32);};function _f(_10){var _11=_b.cellNavigation,_12=_11?_8:_9,_13=_10===_b.headerNode,_14=_10;function _15(){if(_b._focusedHeaderNode){_b._focusedHeaderNode.tabIndex=-1;}if(_b.showHeader){if(_11){var _16=_b.headerNode.getElementsByTagName("th");for(var i=0,_17;(_17=_16[i]);++i){if(_12.test(_17.className)){_b._focusedHeaderNode=_14=_17;break;}}}else{_b._focusedHeaderNode=_14=_b.headerNode;}if(_14){_14.tabIndex=_b.tabIndex;}}};if(_13){_15();_2.after(_b,"renderHeader",_15,true);}else{_2.after(_b,"renderArray",function(_18){var _19=_b._focusedNode||_14;if(_12.test(_19.className)&&_6.contains(_10,_19)){return _18;}var _1a=_10.getElementsByTagName("*");for(var i=0,_1b;(_1b=_1a[i]);++i){if(_12.test(_1b.className)){_19=_b._focusedNode=_1b;break;}}_19.tabIndex=_b.tabIndex;return _18;});}_b._listeners.push(on(_10,"mousedown",function(_1c){if(!_c(_1c)){_b._focusOnNode(_1c.target,_13,_1c);}}));_b._listeners.push(on(_10,"keydown",function(_1d){if(_1d.metaKey||_1d.altKey){return;}var _1e=_b[_13?"headerKeyMap":"keyMap"][_1d.keyCode];if(_1e&&!_c(_1d)){_1e.call(_b,_1d);}}));};if(this.tabableHeader){_f(this.headerNode);on(this.headerNode,"dgrid-cellfocusin",function(){_b.scrollTo({x:this.scrollLeft});});}_f(this.contentNode);},removeRow:function(_1f){if(!this._focusedNode){return this.inherited(arguments);}var _20=this,_21=document.activeElement===this._focusedNode,_22=this[this.cellNavigation?"cell":"row"](this._focusedNode),_23=_22.row||_22,_24;_1f=_1f.element||_1f;if(_1f===_23.element){_24=this.down(_23,true);if(!_24||_24.element===_1f){_24=this.up(_23,true);}this._removedFocus={active:_21,rowId:_23.id,columnId:_22.column&&_22.column.id,siblingId:!_24||_24.element===_1f?undefined:_24.id};setTimeout(function(){if(_20._removedFocus){_20._restoreFocus(_23.id);}},0);this._focusedNode=null;}this.inherited(arguments);},insertRow:function(){var _25=this.inherited(arguments);if(this._removedFocus&&!this._removedFocus.wait){this._restoreFocus(_25);}return _25;},_restoreFocus:function(row){var _26=this._removedFocus,_27,_28;row=row&&this.row(row);_27=row&&row.element&&row.id===_26.rowId?row:typeof _26.siblingId!=="undefined"&&this.row(_26.siblingId);if(_27&&_27.element){if(!_27.element.parentNode.parentNode){_26.wait=true;return;}if(typeof _26.columnId!=="undefined"){_28=this.cell(_27,_26.columnId);if(_28&&_28.element){_27=_28;}}if(_26.active&&_27.element.offsetHeight!==0){this._focusOnNode(_27,false,null);}else{_5(_27.element,".dgrid-focus");_27.element.tabIndex=this.tabIndex;this._focusedNode=_27.element;}}delete this._removedFocus;},addKeyHandler:function(key,_29,_2a){return _2.after(this[_2a?"headerKeyMap":"keyMap"],key,_29,true);},_focusOnNode:function(_2b,_2c,_2d){var _2e="_focused"+(_2c?"Header":"")+"Node",_2f=this[_2e],_30=this.cellNavigation?"cell":"row",_31=this[_30](_2b),_32,_33,_34,_35,i;_2b=_31&&_31.element;if(!_2b){return;}if(this.cellNavigation){_32=_2b.getElementsByTagName("input");for(i=0,_34=_32.length;i<_34;i++){_33=_32[i];if((_33.tabIndex!==-1||"_dgridLastValue" in _33)&&!_33.disabled){_33.focus();_35=true;break;}}}if(_2d!==null){_2d=_3.mixin({grid:this},_2d);if(_2d.type){_2d.parentType=_2d.type;}if(!_2d.bubbles){_2d.bubbles=true;}}if(_2f){_5(_2f,"!dgrid-focus[!tabIndex]");if(_2d){_2d[_30]=this[_30](_2f);on.emit(_2f,"dgrid-cellfocusout",_2d);}}_2f=this[_2e]=_2b;if(_2d){_2d[_30]=_31;}var _36=this.cellNavigation?_8:_9;if(!_35&&_36.test(_2b.className)){_2b.tabIndex=this.tabIndex;_2b.focus();}_5(_2b,".dgrid-focus");if(_2d){on.emit(_2f,"dgrid-cellfocusin",_2d);}},focusHeader:function(_37){this._focusOnNode(_37||this._focusedHeaderNode,true);},focus:function(_38){var _39=_38||this._focusedNode;if(_39){this._focusOnNode(_39,false);}else{this.contentNode.focus();}}});var _3a=_a.moveFocusVertical=function(_3b,_3c){var _3d=this.cellNavigation,_3e=this[_3d?"cell":"row"](_3b),_3f=_3d&&_3e.column.id,_40=this.down(this._focusedNode,_3c,true);if(_3d){_40=this.cell(_40,_3f);}this._focusOnNode(_40,false,_3b);_3b.preventDefault();};var _41=_a.moveFocusUp=function(_42){_3a.call(this,_42,-1);};var _43=_a.moveFocusDown=function(_44){_3a.call(this,_44,1);};var _45=_a.moveFocusPageUp=function(_46){_3a.call(this,_46,-this.pageSkip);};var _47=_a.moveFocusPageDown=function(_48){_3a.call(this,_48,this.pageSkip);};var _49=_a.moveFocusHorizontal=function(_4a,_4b){if(!this.cellNavigation){return;}var _4c=!this.row(_4a),_4d=this["_focused"+(_4c?"Header":"")+"Node"];this._focusOnNode(this.right(_4d,_4b),_4c,_4a);_4a.preventDefault();};var _4e=_a.moveFocusLeft=function(_4f){_49.call(this,_4f,-1);};var _50=_a.moveFocusRight=function(_51){_49.call(this,_51,1);};var _52=_a.moveHeaderFocusEnd=function(_53,_54){var _55;if(this.cellNavigation){_55=this.headerNode.getElementsByTagName("th");this._focusOnNode(_55[_54?0:_55.length-1],true,_53);}_53.preventDefault();};var _56=_a.moveHeaderFocusHome=function(_57){_52.call(this,_57,true);};var _58=_a.moveFocusEnd=function(_59,_5a){var _5b=this.cellNavigation,_5c=this.contentNode,_5d=_5a?0:_5c.scrollHeight,_5e=_5c.scrollTop+_5d,_5f=_5c[_5a?"firstChild":"lastChild"],_60=_5f.className.indexOf("dgrid-preload")>-1,_61=_60?_5f[(_5a?"next":"previous")+"Sibling"]:_5f,_62=_61.offsetTop+(_5a?0:_61.offsetHeight),_63;if(_60){while(_61&&_61.className.indexOf("dgrid-row")<0){_61=_61[(_5a?"next":"previous")+"Sibling"];}if(!_61){return;}}if(!_60||_5f.offsetHeight<1){if(_5b){_61=this.cell(_61,this.cell(_59).column.id);}this._focusOnNode(_61,false,_59);}else{if(!_4("dom-addeventlistener")){_59=_3.mixin({},_59);}_63=_2.after(this,"renderArray",function(_64){var _65=_64[_5a?0:_64.length-1];if(_5b){_65=this.cell(_65,this.cell(_59).column.id);}this._focusOnNode(_65,false,_59);_63.remove();return _64;});}if(_5e===_62){_59.preventDefault();}};var _66=_a.moveFocusHome=function(_67){_58.call(this,_67,true);};function _68(_69){_69.preventDefault();};_a.defaultKeyMap={32:_68,33:_45,34:_47,35:_58,36:_66,37:_4e,38:_41,39:_50,40:_43};_a.defaultHeaderKeyMap={32:_68,35:_52,36:_56,37:_4e,39:_50};return _a;});