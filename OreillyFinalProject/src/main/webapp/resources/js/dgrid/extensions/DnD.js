//>>built
define("dgrid/extensions/DnD",["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/aspect","dojo/on","dojo/topic","dojo/has","dojo/when","dojo/dnd/Source","dojo/dnd/Manager","dojo/_base/NodeList","put-selector/put","../Selection","dojo/has!touch?../util/touch","dojo/has!touch?./_DnD-touch-autoscroll","xstyle/css!dojo/resources/dnd.css"],function(_1,_2,_3,_4,on,_5,_6,_7,_8,_9,_a,_b,_c,_d){var _e=_1(_8,{grid:null,getObject:function(_f){var _10=this.grid;return _10.collection.get(_f.id.slice(_10.id.length+5));},_legalMouseDown:function(evt){var _11=this.inherited(arguments);return _11&&evt.target!==this.grid.bodyNode;},onDrop:function(_12,_13,_14){var _15=this,_16=this._targetAnchor=this.targetAnchor,_17=this.grid,_18=_17.collection;if(!this.before&&_16){_16=_16.nextSibling;}_16=_16&&_17.row(_16);_7(_16&&_18.get(_16.id),function(_19){if(_15!==_12){_15.onDropExternal(_12,_13,_14,_19);}else{_15.onDropInternal(_13,_14,_19);}});},onDropInternal:function(_1a,_1b,_1c){var _1d=this.grid,_1e=_1d.collection,_1f=this,_20=_1f._targetAnchor,_21,_22;if(_20){_21=this.before?_20.previousSibling:_20.nextSibling;}_22=_1d.row(_1a[0]);if(!_1b&&(_21===_1a[0]||(!_1c&&_22&&_1d.down(_22).element===_1a[0]))){return;}_1a.forEach(function(_23){_7(_1f.getObject(_23),function(_24){var id=_1e.getIdentity(_24);_1e[_1b&&_1e.copy?"copy":"put"](_24,{beforeId:_1c?_1e.getIdentity(_1c):null});if(_1f._selectedNodes[id]){_1f._selectedNodes[id]=_1d.row(id).element;}});});},onDropExternal:function(_25,_26,_27,_28){var _29=this.grid.collection,_2a=_25.grid;_26.forEach(function(_2b,i){_7(_25.getObject(_2b),function(_2c){if(!_27){if(_2a){_7(_2a.collection.getIdentity(_2c),function(id){!i&&_25.selectNone();_25.delItem(_2b.id);_2a.collection.remove(id);});}else{_25.deleteSelectedNodes();}}_29[_29.copy?"copy":"put"](_2c,{beforeId:_28?_29.getIdentity(_28):null});});});},onDndStart:function(_2d){this.inherited(arguments);if(_2d===this){if(this.grid.cancelTouchScroll){this.grid.cancelTouchScroll();}_9.manager().avatar.node.style.width=this.grid.domNode.offsetWidth/2+"px";}},onMouseDown:function(evt){if(_6("touch")&&this.isDragging&&_d.countCurrentTouches(evt,this.grid.touchNode)>1){_5.publish("/dnd/cancel");_9.manager().stopDrag();}else{this.inherited(arguments);}},onMouseMove:function(evt){if(!_6("touch")||_d.countCurrentTouches(evt,this.grid.touchNode)<=1){this.inherited(arguments);}},checkAcceptance:function(_2e){return _2e.getObject&&_8.prototype.checkAcceptance.apply(this,arguments);},getSelectedNodes:function(){if(!this.grid.selection){return this.inherited(arguments);}var t=new _a(),id;for(id in this.grid.selection){t.push(this._selectedNodes[id]);}return t;}});var DnD=_1(_c,{dndSourceType:"dgrid-row",dndParams:null,dndConstructor:_e,postMixInProperties:function(){this.inherited(arguments);this.dndParams=_2.mixin({accept:[this.dndSourceType]},this.dndParams);},postCreate:function(){this.inherited(arguments);var _2f=this.dndConstructor||_e;this.dndSource=new _2f(this.bodyNode,_2.mixin(this.dndParams,{grid:this,dropParent:this.contentNode}));var _30=this.dndSource._selectedNodes={};function _31(row){_30[row.id]=row.element;};function _32(row){delete _30[row.id];_b(row.element,"!dojoDndItemSelected!dojoDndItemAnchor");};this.on("dgrid-select",function(_33){_3.forEach(_33.rows,_31);});this.on("dgrid-deselect",function(_34){_3.forEach(_34.rows,_32);});_4.after(this,"destroy",function(){delete this.dndSource._selectedNodes;_30=null;this.dndSource.destroy();},true);},insertRow:function(_35){var row=this.inherited(arguments),_36=typeof this.getObjectDndType==="function"?this.getObjectDndType(_35):[this.dndSourceType];_b(row,".dojoDndItem");this.dndSource.setItem(row.id,{data:_35,type:_36 instanceof Array?_36:[_36]});return row;},removeRow:function(_37){this.dndSource.delItem(this.row(_37));this.inherited(arguments);}});DnD.GridSource=_e;return DnD;});