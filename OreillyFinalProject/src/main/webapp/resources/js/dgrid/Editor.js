//>>built
define("dgrid/Editor",["dojo/_base/declare","dojo/_base/lang","dojo/Deferred","dojo/on","dojo/has","dojo/query","./Grid","put-selector/put","dojo/_base/sniff"],function(_1,_2,_3,on,_4,_5,_6,_7){return _1(null,{constructor:function(){this._editorInstances={};this._editorColumnListeners=[];this._editorsPendingStartup=[];},postCreate:function(){var _8=this;this.inherited(arguments);this.on(".dgrid-input:focusin",function(){_8._focusedEditorCell=_8.cell(this);});this._editorFocusoutHandle=on.pausable(this.domNode,".dgrid-input:focusout",function(){_8._focusedEditorCell=null;});this._listeners.push(this._editorFocusoutHandle);},insertRow:function(){var _9=this.inherited(arguments);var _a=this.row(_9);var _b=this._previouslyFocusedEditorCell;if(_b&&_b.row.id===_a.id){this.edit(this.cell(_a,_b.column.id));}return _9;},removeRow:function(_c){var _d=this;var _e=this._focusedEditorCell;if(_e&&_e.row.id===this.row(_c).id){this._previouslyFocusedEditorCell=_e;this._editorFocusoutHandle.pause();setTimeout(function(){_d._editorFocusoutHandle.resume();_d._previouslyFocusedEditorCell=null;},0);}for(var i=this._alwaysOnWidgetColumns.length;i--;){var _f=this.cell(_c,this._alwaysOnWidgetColumns[i].id).element,_10=_f&&(_f.contents||_f).widget;if(_10){this._editorFocusoutHandle.pause();_10.destroyRecursive();}}return this.inherited(arguments);},renderArray:function(){var _11=this.inherited(arguments);if(_11.length){this._startupPendingEditors();}else{this._editorsPendingStartup=[];}return _11;},_onNotification:function(){this.inherited(arguments);this._startupPendingEditors();},_destroyColumns:function(){this._editorStructureCleanup();this.inherited(arguments);},_editorStructureCleanup:function(){var _12=this._editorInstances;var _13=this._editorColumnListeners;if(this._editTimer){clearTimeout(this._editTimer);}for(var _14 in _12){var _15=_12[_14];if(_15.domNode){_15.destroyRecursive();}}this._editorInstances={};for(var i=_13.length;i--;){_13[i].remove();}this._editorColumnListeners=[];this._editorsPendingStartup=[];},_configColumns:function(){var _16=this.inherited(arguments);this._alwaysOnWidgetColumns=[];for(var i=0,l=_16.length;i<l;i++){if(_16[i].editor){this._configureEditorColumn(_16[i]);}}return _16;},_configureEditorColumn:function(_17){var _18=_17.editor;var _19=this;var _1a=_17.renderCell||this._defaultRenderCell;var _1b=_17.editOn;var _1c=typeof _18!=="string";if(_1b){this._editorInstances[_17.id]=this._createSharedEditor(_17,_1a);}else{if(_1c){this._alwaysOnWidgetColumns.push(_17);}}_17.renderCell=_1b?function(_1d,_1e,_1f,_20){if(!_20||!_20.alreadyHooked){_19._editorColumnListeners.push(on(_1f,_1b,function(){_19._activeOptions=_20;_19.edit(this);}));}return _1a.call(_17,_1d,_1e,_1f,_20);}:function(_21,_22,_23,_24){if(!_17.canEdit||_17.canEdit(_21,_22)){var cmp=_19._createEditor(_17);_19._showEditor(cmp,_17,_23,_22);_23[_1c?"widget":"input"]=cmp;}else{return _1a.call(_17,_21,_22,_23,_24);}};},edit:function(_25){var _26=this;var _27;var _28;var _29;var _2a;var _2b;var cmp;var dfd;function _2c(dfd){_26._activeCell=_28;_26._showEditor(cmp,_27,_28,_2b);_26._editTimer=setTimeout(function(){if(cmp.focus){cmp.focus();}if(_27._editorBlurHandle){_27._editorBlurHandle.resume();}_26._editTimer=null;dfd.resolve(cmp);},0);};if(!_25.column){_25=this.cell(_25);}if(!_25||!_25.element){return null;}_27=_25.column;_2a=_27.field;_28=_25.element.contents||_25.element;if((cmp=this._editorInstances[_27.id])){if(this._activeCell!==_28){var row=_25.row;_29=this.dirty&&this.dirty[row.id];_2b=(_29&&_2a in _29)?_29[_2a]:_27.get?_27.get(row.data):row.data[_2a];if(!_27.canEdit||_27.canEdit(_25.row.data,_2b)){dfd=new _3();var _2d=cmp.domNode||cmp;if(_2d.offsetWidth){_2d.blur();setTimeout(function(){_2c(dfd);},0);}else{_2c(dfd);}return dfd.promise;}}}else{if(_27.editor){cmp=_28.widget||_28.input;if(cmp){dfd=new _3();if(cmp.focus){cmp.focus();}dfd.resolve(cmp);return dfd.promise;}}}return null;},_showEditor:function(cmp,_2e,_2f,_30){var _31=cmp.domNode;if(!_31){this._updateInputValue(cmp,_30);}_2f.innerHTML="";_7(_2f,".dgrid-cell-editing");_7(_2f,cmp.domNode||cmp);if(_31&&!_2e.editOn){this._editorsPendingStartup.push([cmp,_2e,_2f,_30]);}else{this._startupEditor(cmp,_2e,_2f,_30);}},_startupEditor:function(cmp,_32,_33,_34){if(cmp.domNode){if(!cmp._started){cmp.startup();}cmp._dgridIgnoreChange=true;cmp.set("value",_34);setTimeout(function(){cmp._dgridIgnoreChange=false;},0);}cmp._dgridLastValue=_34;if(this._activeCell){this._activeValue=_34;on.emit(_33,"dgrid-editor-show",{grid:this,cell:this.cell(_33),column:_32,editor:cmp,bubbles:true,cancelable:false});}},_startupPendingEditors:function(){var _35=this._editorsPendingStartup;for(var i=_35.length;i--;){this._startupEditor.apply(this,_35[i]);}this._editorsPendingStartup=[];},_handleEditorChange:function(evt,_36){var _37=evt.target;if("_dgridLastValue" in _37&&_37.className.indexOf("dgrid-input")>-1){this._updatePropertyFromEditor(_36||this.cell(_37).column,_37,evt);}},_createEditor:function(_38){var _39=_38.editor,_3a=_38.editOn,_3b=this,_3c=typeof _39!=="string"&&_39,_3d,cmp,_3e,_3f;_3d=_38.editorArgs||{};if(typeof _3d==="function"){_3d=_3d.call(this,_38);}if(_3c){cmp=new _3c(_3d);_3e=cmp.focusNode||cmp.domNode;_3e.className+=" dgrid-input";cmp.on(_3a?"blur":"change",function(){if(!cmp._dgridIgnoreChange){_3b._updatePropertyFromEditor(_38,this,{type:"widget"});}});}else{if(!this._hasInputListener){this._hasInputListener=true;this.on("change",function(evt){_3b._handleEditorChange(evt);});}_3f=_39==="textarea"?"textarea":"input[type="+_39+"]";cmp=_3e=_7(_3f+".dgrid-input",_2.mixin({name:_38.field,tabIndex:isNaN(_38.tabIndex)?-1:_38.tabIndex},_3d));if(_4("ie")<9){if(_39==="radio"||_39==="checkbox"){this._editorColumnListeners.push(on(cmp,"click",function(evt){_3b._handleEditorChange(evt,_38);}));}else{this._editorColumnListeners.push(on(cmp,"change",function(evt){_3b._handleEditorChange(evt,_38);}));}}}if(_38.autoSelect){var _40=cmp.focusNode||cmp;if(_40.select){on(_40,"focus",function(){setTimeout(function(){_40.select();},0);});}}return cmp;},_createSharedEditor:function(_41){var cmp=this._createEditor(_41),_42=this,_43=cmp.domNode,_44=cmp.domNode||cmp,_45=cmp.focusNode||_44,_46=_43?function(){cmp.set("value",cmp._dgridLastValue);}:function(){_42._updateInputValue(cmp,cmp._dgridLastValue);_42._updatePropertyFromEditor(_41,cmp);};function _47(){var _48=_42._activeCell;_45.blur();if(typeof _42.focus==="function"){setTimeout(function(){_42.focus(_48);},_43&&_4("ie")<9?15:0);}};function _49(){var _4a=_44.parentNode,i=_4a.children.length-1,_4b={alreadyHooked:true},_4c=_42.cell(_44);on.emit(_4c.element,"dgrid-editor-hide",{grid:_42,cell:_4c,column:_41,editor:cmp,bubbles:true,cancelable:false});_41._editorBlurHandle.pause();_4a.removeChild(_44);if(_4c.row){_7(_4c.element,"!dgrid-cell-editing");while(i--){_7(_4a.firstChild,"!");}_6.appendIfNode(_4a,_41.renderCell(_4c.row.data,_42._activeValue,_4a,_42._activeOptions?_2.delegate(_4b,_42._activeOptions):_4b));}_42._focusedEditorCell=_42._activeCell=_42._activeValue=_42._activeOptions=null;};function _4d(evt){var key=evt.keyCode||evt.which;if(key===27){_46();_42._activeValue=cmp._dgridLastValue;_47();}else{if(key===13&&_41.dismissOnEnter!==false){_47();}}};this._editorColumnListeners.push(on(_45,"keydown",_4d));(_41._editorBlurHandle=on.pausable(cmp,"blur",_49)).pause();this._editorColumnListeners.push(_41._editorBlurHandle);return cmp;},_updatePropertyFromEditor:function(_4e,cmp,_4f){var _50,id,_51;if(!cmp.isValid||cmp.isValid()){_50=this._updateProperty((cmp.domNode||cmp).parentNode,this._activeCell?this._activeValue:cmp._dgridLastValue,this._retrieveEditorValue(_4e,cmp),_4f);if(this._activeCell){this._activeValue=_50;}else{cmp._dgridLastValue=_50;}if(cmp.type==="radio"&&cmp.name&&!_4e.editOn&&_4e.field){_51=this.row(cmp);_5("input[type=radio][name="+cmp.name+"]",this.contentNode).forEach(function(_52){var row=this.row(_52);if(_52!==cmp&&_52._dgridLastValue){_52._dgridLastValue=false;if(this.updateDirty){this.updateDirty(row.id,_4e.field,false);}else{row.data[_4e.field]=false;}}},this);for(id in this.dirty){if(_51.id.toString()!==id&&this.dirty[id][_4e.field]){this.updateDirty(id,_4e.field,false);}}}}},_updateProperty:function(_53,_54,_55,_56){var _57=this;if((_54&&_54.valueOf())!==(_55&&_55.valueOf())){var _58=this.cell(_53);var row=_58.row;var _59=_58.column;_53=_58.element;if(_59.field&&row){var _5a={grid:this,cell:_58,oldValue:_54,value:_55,bubbles:true,cancelable:true};if(_56&&_56.type){_5a.parentType=_56.type;}if(on.emit(_53,"dgrid-datachange",_5a)){if(this.updateDirty){this.updateDirty(row.id,_59.field,_55);if(_59.autoSave){setTimeout(function(){_57._trackError("save");},0);}}else{row.data[_59.field]=_55;}}else{var cmp;if((cmp=_53.widget)){cmp._dgridIgnoreChange=true;cmp.set("value",_54);setTimeout(function(){cmp._dgridIgnoreChange=false;},0);}else{if((cmp=_53.input)){this._updateInputValue(cmp,_54);}}return _54;}}}return _55;},_updateInputValue:function(_5b,_5c){_5b.value=_5c;if(_5b.type==="radio"||_5b.type==="checkbox"){_5b.checked=_5b.defaultChecked=!!_5c;}},_retrieveEditorValue:function(_5d,cmp){if(typeof cmp.get==="function"){return this._convertEditorValue(cmp.get("value"));}else{return this._convertEditorValue(cmp[cmp.type==="checkbox"||cmp.type==="radio"?"checked":"value"]);}},_convertEditorValue:function(_5e,_5f){if(typeof _5f==="number"){_5e=isNaN(_5e)?_5e:parseFloat(_5e);}else{if(typeof _5f==="boolean"){_5e=_5e==="true"?true:_5e==="false"?false:_5e;}else{if(_5f instanceof Date){var _60=new Date(_5e);_5e=isNaN(_60.getTime())?_5e:_60;}}}return _5e;}});});