//>>built
define("oreilly/types/form/NewChosen",["dojo/_base/declare","dojo/_base/lang","dojo/sniff","dijit/form/FilteringSelect","dojo/dom-class","dojo/dom-construct","dojo/dom-geometry","dojo/dom-style","dojo/_base/array","dojo/when","dojo/query","dojo/NodeList-traverse","dijit/Tooltip","dojo/on","dojo/store/util/SimpleQueryEngine","dojo/dom","dojo/keys"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,on,_e,_f,_10){return _1("oreilly.types.form.NewChosen",[_4],{hasDownArrow:true,autoComplete:false,pending_destroy_click:false,valueSeparator:",",minKeyCount:3,multiple:true,placeHolder:"Please select an item",pageSize:5,labelAttr:"name",cssStateNodes:{"_buttonNode":"chosenTextBox"},sf:null,templateString:""+"<div class=\"dijitChosen dijit dijitReset dijitInline dijitLeft\"\n\tid=\"widget_${id}\"\n\trole=\"combobox\"\n\taria-haspopup=\"true\"\n\tdata-dojo-attach-point=\"_popupStateNode\"\n\tstyle=\"width: 100%\">"+"   <div class=\"dijitReset dijitRight dijitButtonNode dijitArrowButton dijitDownArrowButton dijitArrowButtonContainer\" data-dojo-attach-point=\"_arrow\" role=\"presentation\"><input class=\"dijitReset dijitInputField dijitArrowButtonInner\" value=\"&#x25B2; \" type=\"text\" tabindex=\"-1\" readonly=\"readonly\" role=\"button presentation\" aria-hidden=\"true\"></div>"+"\t<div style=\"display:none;\"class='dijitReset dijitValidationContainer'\n\t\t>"+"\t\t<input class=\"dijitReset dijitInputField dijitValidationIcon dijitValidationInner\" value=\"&#935; \" type=\"text\" tabIndex=\"-1\" readonly=\"readonly\" role=\"presentation\"\n\t/>"+"\t</div\n\t>"+"\t<div data-dojo-attach-point=\"chosenBox, _buttonNode\" class=\"chzn-container\" role=\"presentation\" >"+"\t\t<ul class=\"chzn-choices\">"+"\t\t\t<li class=\"search-field\" >"+" \t\t\t\t"+"\t\t\t\t<input type=\"text\" class=\"dijitReset dijitInputInner \"  style=\"width: 100% !important;\" data-dojo-attach-point=\"textbox, focusNode\" autocomplete=\"off\" role=\"textbox\"  />"+"\t\t\t\t"+"\t\t\t</li>"+"\t\t</ul>"+"\t</div>"+" </div>\n",_onDropDownMouseDown:function(e){if(_5.contains(e.target,"search-choice-close")){return;}this.inherited(arguments);},_announceOption:function(_11){this.inherited(arguments);this.textbox.value="";this._updatePlaceHolder();},_updatePlaceHolder:function(){if(this._phspan){if(this.focused){this._phspan.style.display="none";}else{if(this.valueNode.children.length>0){this._phspan.style.display="none";}else{this._phspan.style.display="";}}}if(this.required){this.set("state",(this.valueNode.children.length>0)?"":"Error");}},_setBlurValue:function(){this.textbox.value="";},add_item_to_selection:function(_12){var _13=this._generate_option_id(_12.id||(this.store&&_12[this.store.idProperty]));var _14=_6.create("option",{"id":_13,value:(_12.id||(this.store&&_12[this.store.idProperty])),"selected":"selected"});_6.place(_14,this.valueNode,"last");if(!this.multiple){_8.set(this.sf,"display","none");}},remove_item_from_selection:function(_15){var _16=this._generate_option_id(_15);_6.destroy(_f.byId(_16));},isSelected:function(_17){var _18=false,_19=this;_9.forEach(_19.valueNode.children,function(_1a){if(_1a.id==_19._generate_option_id(_17.id||(_19.store&&_17[_19.store.idProperty]))){_18=true;}});return _18;},_setItemAttr:function(_1b,_1c,_1d){if(!_1b){return;}var _1e="";if(_1b.i){if(this.labelAttr){_1e=_1b.i[this.labelAttr];}_1b=_1b.i;}else{if(this.labelAttr){_1e=_1b[this.labelAttr];}else{_1e=_1b.name;}}if(_1b.id||(this.store&&_1b[this.store.idProperty])){if(!this.isSelected(_1b)){this.choice_build(_1b,_1e);}}},_generate_link_id:function(_1f){return this.id+"_l_"+((_1f)?_1f:"");},_generate_option_id:function(_20){return this.id+"_c_"+((_20)?_20:"");},_setStoreAttr:function(_21){if(_21.declaredClass!=="dijit.form.DataList"){this.get("store").idProperty=_21.idProperty;this.get("store").setData(_21.data);return;}this.inherited(arguments);},choice_destroy:function(_22,_23){var li=_c(_22).parent("li")[0];var _24=li.id;var _25=this._generate_link_id();var _26=_24.substring(_25.length);this.remove_item_from_selection(_26);_6.destroy(li);if(!_23){this._onChange();}},choice_build:function(_27,_28){var _29=this._generate_link_id(_27.id||(this.store&&_27[this.store.idProperty])),_2a=this,_2b="";if(!this.multiple){_b("a.search-choice-close",this.chosenBox).forEach(function(_2c){_2a.choice_destroy(_2c,true);});}var el=_6.create("li",{"id":_29});_5.add(el,"search-choice"+(this.multiple?"":"-single"));if(!this.multiple&&!this.allow_single_deselect){_2b="hidden";}el.innerHTML="<span>"+_28+"</span><a href=\"#\" class=\"search-choice-close "+_2b+"\"></a>";_6.place(el,this.search_container,"before");this.add_item_to_selection(_27);this._onChange();},postCreate:function(_2d){var wt=this;this.inherited(arguments);if(this.store.queryEngine){this.store.queryEngine=this.generateSimpleQueryEngineWrapper();}if(this.store._filterResponse){this.store._filterResponse=this.generateClientFilter();}if(this.multiple){_5.add(this.chosenBox,"chzn-container-multi");_8.set(this._arrow,"display","none");}else{_5.add(this.chosenBox,"chzn-container-single");if(!this.hasDownArrow){_8.set(this._arrow,"display","none");}}on(this.focusNode,"keyup",this.keyup_checker.bind(this));on(this.focusNode,"keydown",this.keydown_checker.bind(this));on(this,"search",function(){_5.remove(this.textbox,"filteringselect-spinning");});on(this.domNode,"click",function(e){if(e.target===wt.domNode){wt._startSearch("");}else{if(_5.contains(e.target,"search-choice-close")){e.preventDefault();e.stopPropagation();if(!wt.is_disabled){wt.choice_destroy(e.target);}else{e.stop();}}else{if(_f.isDescendant(e.target,wt.domNode)){wt._startSearch("");}}}});},keyup_checker:function(evt){switch(evt.keyCode){case _10.BACKSPACE:if((this.getSelected().length>0)&&(this.textbox.value.length==0)){this.closeDropDown();}break;default:}_8.set(this.sf,"width",(this._lastInput.length<=2?3:this._lastInput.length)*12+"px");if(_8.get(this.sf,"width")>_8.get(this.domNode,"width")){_8.set(this.sf,"width",_8.get(this.domNode,"width")+"px");}},keydown_checker:function(evt){switch(evt.keyCode){case _10.BACKSPACE:if((this.getSelected().length>0)&&(this.textbox.value.length==0)){if(!this._opened){var _2e=_b("a.search-choice-close",this.chosenBox).pop();this.choice_destroy(_2e);}}break;default:}},buildRendering:function(){this.inherited(arguments);_6.destroy(this.valueNode);this.valueNode=_6.place("<select multiple='"+(this.multiple?"multiple":"")+"'"+((this.name&&!_3("msapp"))?" name=\""+this.name.replace(/"/g,"&quot;")+"\"":"")+"/>",this.textbox,"after");this.sf=_b(".search-field",this.domNode)[0];this.search_container=_b("li.search-field",this.chosenBox).shift();_8.set(this.valueNode,"display","none");},getSelected:function(){return _9.filter(this.valueNode.children,function(n){return n.selected;});},_getValueAttr:function(){if(!this.multiple){return this.getSelected()[0]?this.getSelected()[0].value:"";}return _9.map(this.getSelected(),function(n){return n.value;});},_setValueAttr:function(_2f,_30){var _31=this;if(typeof _2f==="string"){if(!_2.trim(_2f)){_2f=[];}else{_2f=_2f.split(this.valueSeparator);}}if(!!_2f&&!(_2f instanceof Array)){_2f=[_2f];}if(!this.multiple){_2f=[_2f.shift()];}_b("a.search-choice-close",this.chosenBox).forEach(function(_32){_31.choice_destroy(_32,true);});_9.forEach(_2f,function(_33){_a(_31.store.get(_33),function(_34){if(_34){_31._setItemAttr(_34,undefined,undefined,_30);}});});this._updatePlaceHolder();},generateClientFilter:function(){var _35=this;return function(_36){_36.items=_9.filter(_36.items,function(_37){return (!_35.isSelected(_37));});return _36;};},generateSimpleQueryEngineWrapper:function(){var _38=this;return function(_39,_3a){var _3b=_39;_39=function(_3c){if(_38.isSelected(_3c)){return false;}for(var key in _3b){var _3d=_3b[key];if(_3d&&_3d.test){if(!_3d.test(_3c[key],_3c)){return false;}}else{if(_3d!=_3c[key]){return false;}}}return true;};return _e(_39,_3a);};},isValid:function(_3e){var _3f=true;if((this.required)&&(this.valueNode.children.length===0)){_3f=false;}return _3f;},validate:function(_40){var _41="";var _42=this.disabled||this.isValid(_40);if(_42){this._maskValidSubsetError=true;}var _43=this._isEmpty(this.textbox.value);var _44=!_42&&_40&&this._isValidSubset();this._set("state",_42?"":(((((!this._hasBeenBlurred||_40)&&_43)||_44)&&(this._maskValidSubsetError||(_44&&!this._hasBeenBlurred&&_40)))?"Incomplete":"Error"));this.focusNode.setAttribute("aria-invalid",_42?"false":"true");if(this.state=="Error"){this._maskValidSubsetError=_40&&_44;_41=this.getErrorMessage(_40);}else{if(this.state=="Incomplete"){_41=this.getPromptMessage(_40);this._maskValidSubsetError=!this._hasBeenBlurred||_40;}else{if(_43){_41=this.getPromptMessage(_40);}}}this.set("message",_41);return _42;},_onKey:function(evt){if(evt.charCode>=32){return;}var key=evt.charCode||evt.keyCode;if(key==_10.ALT||key==_10.CTRL||key==_10.META||key==_10.SHIFT){return;}var pw=this.dropDown;var _45=null;this._abortQuery();if(this.disabled||this.readOnly){return;}var d=this.dropDown,_46=evt.target;if(d&&this._opened&&d.handleKey){if(d.handleKey(evt)===false){evt.stopPropagation();evt.preventDefault();return;}}if(d&&this._opened&&evt.keyCode==_10.ESCAPE){this.closeDropDown();evt.stopPropagation();evt.preventDefault();}else{if(!this._opened&&(evt.keyCode==_10.DOWN_ARROW||((evt.keyCode==_10.ENTER||(evt.keyCode==_10.SPACE&&(!this._searchTimer||(evt.ctrlKey||evt.altKey||evt.metaKey))))&&((_46.tagName||"").toLowerCase()!=="input"||(_46.type&&_46.type.toLowerCase()!=="text"))))){this._toggleOnKeyUp=true;evt.stopPropagation();evt.preventDefault();}}if(evt.altKey||evt.ctrlKey||evt.metaKey){return;}if(this._opened){_45=pw.getHighlightedOption();}switch(key){case _10.PAGE_DOWN:case _10.DOWN_ARROW:case _10.PAGE_UP:case _10.UP_ARROW:evt.stopPropagation();evt.preventDefault();break;case _10.ENTER:if(_45){if(_45==pw.nextButton){this._nextSearch(1);evt.stopPropagation();evt.preventDefault();break;}else{if(_45==pw.previousButton){this._nextSearch(-1);evt.stopPropagation();evt.preventDefault();break;}}evt.stopPropagation();evt.preventDefault();}else{this._setBlurValue();this._setCaretPos(this.focusNode,this.focusNode.value.length);}case _10.TAB:var _47=this.get("displayedValue");if(pw&&(_47==pw._messages["previousMessage"]||_47==pw._messages["nextMessage"])){break;}if(_45){this._selectOption(_45);}case _10.ESCAPE:if(this._opened){this._lastQuery=null;this.closeDropDown();}break;}},_onChange:function(_48){this._handleOnChange(this.get("value"),true);}});});