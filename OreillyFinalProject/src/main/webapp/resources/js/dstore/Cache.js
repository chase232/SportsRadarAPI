//>>built
define("dstore/Cache",["dojo/_base/array","dojo/when","dojo/_base/declare","dojo/_base/lang","./Store","./Memory","./QueryResults"],function(_1,_2,_3,_4,_5,_6,_7){function _8(_9){return function(){var _a=this.inherited(arguments);var _b=this.cachingCollection||this.cachingStore;_a.cachingCollection=_b[_9].apply(_b,arguments);_a.isValidFetchCache=this.canCacheQuery===true||this.canCacheQuery(_9,arguments);return _a;};};function _c(_d){if(!_d.cachingStore){_d.cachingStore=new _6();}_d.cachingStore.Model=_d.Model;_d.cachingStore.idProperty=_d.idProperty;};var _e={cachingStore:null,constructor:function(){_c(this);},canCacheQuery:function(_f,_10){return false;},isAvailableInCache:function(){return (this.isValidFetchCache&&(this.allLoaded||this.fetchRequest))||this._parent&&this._parent.isAvailableInCache();},fetch:function(){return this._fetch(arguments);},fetchRange:function(){return this._fetch(arguments,true);},_fetch:function(_11,_12){var _13=this.cachingStore;var _14=this.cachingCollection||_13;var _15=this;var _16=this.isAvailableInCache();if(_16){return new _7(_2(_16,function(){if(_15.isAvailableInCache()){return _12?_14.fetchRange(_11[0]):_14.fetch();}else{return _15.inherited(_11);}}));}var _17=this.fetchRequest=this.inherited(_11);_2(_17,function(_18){var _19=!_12;_15.fetchRequest=null;_1.forEach(_18,function(_1a){if(!_15.isLoaded||_15.isLoaded(_1a)){_13.put(_1a);}else{_19=false;}});if(_19){_15.allLoaded=true;}return _18;});return _17;},isValidFetchCache:false,get:function(id,_1b){var _1c=this.cachingStore;var _1d=this.getInherited(arguments);var _1e=this;return _2(this.fetchRequest,function(){return _2(_1c.get(id),function(_1f){if(_1f!==undefined){return _1f;}else{if(_1d){return _2(_1d.call(_1e,id,_1b),function(_20){if(_20){_1c.put(_20,{id:id});}return _20;});}}});});},add:function(_21,_22){var _23=this.cachingStore;return _2(this.inherited(arguments),function(_24){_23.put(_21&&typeof _24==="object"?_24:_21,_22);return _24;});},put:function(_25,_26){var _27=this.cachingStore;_27.remove((_26&&_26.id)||this.getIdentity(_25));return _2(this.inherited(arguments),function(_28){_27.put(_25&&typeof _28==="object"?_28:_25,_26);return _28;});},remove:function(id,_29){var _2a=this.cachingStore;return _2(this.inherited(arguments),function(_2b){return _2(_2a.remove(id,_29),function(){return _2b;});});},evict:function(id){this.allLoaded=false;return this.cachingStore.remove(id);},invalidate:function(){this.allLoaded=false;},_createSubCollection:function(){var _2c=this.inherited(arguments);_2c._parent=this;return _2c;},sort:_8("sort"),filter:_8("filter"),_getQuerierFactory:function(_2d){var _2e=this.cachingStore;return this.inherited(arguments)||_4.hitch(_2e,_2e._getQuerierFactory(_2d));}};var _2f=_3(null,_e);_2f.create=function(_30,_31){_30=_3.safeMixin(_4.delegate(_30),_e);_3.safeMixin(_30,_31);_c(_30);return _30;};return _2f;});