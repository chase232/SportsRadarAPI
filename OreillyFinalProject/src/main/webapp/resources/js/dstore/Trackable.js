//>>built
define("dstore/Trackable",["dojo/_base/lang","dojo/_base/declare","dojo/aspect","dojo/when","dojo/promise/all","dojo/_base/array","dojo/on"],function(_1,_2,_3,_4,_5,_6,on){var _7=0;function _8(_9,_a){return {start:_9,count:_a-_9};};function _b(_c,_d,_e){for(var i=_c.length-1;i>=0;--i){var _f=_c[i],_10=_f.start,_11=_10+_f.count;if(_d>_11){_c.splice(i+1,0,_8(_d,_e));return;}else{if(_e>=_10){_d=Math.min(_d,_10);_e=Math.max(_e,_11);_c.splice(i,1);}}}_c.unshift(_8(_d,_e));};function _12(_13,_14,end){for(var i=0,_15;(_15=_13[i]);++i){var _16=_15.start,_17=_16+_15.count;if(_14<=_16){if(end>=_17){_13.splice(i,1);}else{_15.start=end;_15.count=_17-_15.start;return;}}else{if(_14<_17){if(end>_16){_13.splice(i,1,_8(_16,_14),_8(end,_17));return;}else{_15.count=_14-_15.start;}}}}};var _18={track:function(){var _19=this.store||this;var _1a=[];var _1b={add:1,update:1,"delete":1};for(var _1c in _1b){_1a.push(this.on(_1c,(function(_1d){return function(_1e){_1f(_1d,_1e);};})(_1c)));}function _20(){return function(){var _21=this;return _4(this.inherited(arguments),function(_22){_22=_21._results=_22.slice();_21._ranges=[];_b(_21._ranges,0,_22.length);return _22;});};};function _23(){return function(_24){var _25=this,_26=_24.start,end=_24.end,_27=this.inherited(arguments);_4(_27,function(_28){return _4(_28.totalLength,function(_29){var _2a=_25._partialResults||(_25._partialResults=[]);end=Math.min(end,_26+_28.length);_2a.length=_29;var _2b=[_26,end-_26].concat(_28);_2a.splice.apply(_2a,_2b);_b(_25._ranges,_26,end);return _28;});});return _27;};};var _2c=_2.safeMixin(_1.delegate(this),{_ranges:[],fetch:_20(),fetchRange:_23(),releaseRange:function(_2d,end){if(this._partialResults){_12(this._ranges,_2d,end);for(var i=_2d;i<end;++i){delete this._partialResults[i];}}},on:function(_2e,_2f){var _30=this,_31=this.getInherited(arguments);return on.parse(_2c,_2e,_2f,function(_32,_33){return _33 in _1b?_3.after(_2c,"on_tracked"+_33,_2f,true):_31.call(_30,_33,_2f);});},tracking:{remove:function(){while(_1a.length>0){_1a.pop().remove();}this.remove=function(){};}},track:null});if(this.fetchSync){_2.safeMixin(_2c,{fetchSync:_20(),fetchRangeSync:_23()});}var _34;_6.forEach(this.queryLog,function(_35){var _36=_34,_37=_35.querier;if(_37){_34=_36?function(_38){return _37(_36(_38));}:_37;}});var _39={"add":{index:undefined},"update":{previousIndex:undefined,index:undefined},"delete":{previousIndex:undefined}},_3a=function(_3b,id,_3c,end){_3c=_3c!==undefined?_3c:0;end=end!==undefined?end:_3b.length;for(var i=_3c;i<end;++i){if(_19.getIdentity(_3b[i])===id){return i;}}return -1;};function _1f(_3d,_3e){_7++;var _3f=_3e.target;_3e=_1.delegate(_3e,_39[_3d]);_4(_2c._results||_2c._partialResults,function(_40){function _41(){var _42=_2c["on_tracked"+_3d];_42&&_42.call(_2c,_3e);};if(!_40){_41();return;}var i,j,l,_43=_2c._ranges,_44;var _45="id" in _3e?_3e.id:_19.getIdentity(_3f);var _46=-1,_47=-1,_48=-1,_49=-1;if(_3d==="delete"||_3d==="update"){for(i=0;_46===-1&&i<_43.length;++i){_44=_43[i];for(j=_44.start,l=j+_44.count;j<l;++j){var _4a=_40[j];if(_19.getIdentity(_4a)==_45){_46=_3e.previousIndex=j;_47=i;_40.splice(_46,1);_44.count--;for(j=i+1;j<_43.length;++j){_43[j].start--;}break;}}}}if(_3d==="add"||_3d==="update"){if(_34){if(_34([_3f]).length){var _4b=0,end=_43.length-1,_4c,_4d=-1,_4e,_4f;while(_4b<=end&&_48===-1){i=_4b+Math.round((end-_4b)/2);_44=_43[i];_4c=_40.slice(_44.start,_44.start+_44.count);if("beforeId" in _3e){_4d=_3e.beforeId===null?_4c.length:_3a(_4c,_3e.beforeId);}if(_4d===-1){if(_46>=Math.max(0,_44.start-1)&&_46<=(_44.start+_44.count)){_4d=_46;}else{_4d=_19.defaultNewToStart?0:_4c.length;}}_4c.splice(_4d,0,_3f);_4e=_6.indexOf(_34(_4c),_3f);_4f=_44.start+_4e;if(_4e===0&&_44.start!==0){end=i-1;}else{if(_4e>=(_4c.length-1)&&_4f<_40.length){_4b=i+1;}else{_48=_4f;_49=i;}}}}}else{var _44,_50=-1;if("beforeId" in _3e){if(_3e.beforeId===null){_48=_40.length;_50=_43.length-1;}else{for(i=0,l=_43.length;_49===-1&&i<l;++i){_44=_43[i];_48=_3a(_40,_3e.beforeId,_44.start,_44.start+_44.count);if(_48!==-1){_49=i;}}}}else{if(_3d==="update"){_48=_46;_49=_47;}else{if(_19.defaultNewToStart){_48=0;_50=0;}else{_48=_40.length;_50=_43.length-1;}}}if(_50!==-1&&_49===-1){_44=_43[_50];if(_44&&_44.start<=_48&&_48<=(_44.start+_44.count)){_49=_50;}}}if(_48>-1&&_49>-1){_3e.index=_48;_40.splice(_48,0,_3f);_43[_49].count++;for(i=_49+1;i<_43.length;++i){_43[i].start++;}}}_3e.totalLength=_40.length;_41();});};return _2c;}};var _51=_2(null,_18);_51.create=function(_52,_53){_52=_2.safeMixin(_1.delegate(_52),_18);_2.safeMixin(_52,_53);return _52;};return _51;});